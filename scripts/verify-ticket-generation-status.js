#!/usr/bin/env node

/**
 * Verify Ticket Generation Status
 * 
 * This script checks if tickets were generated by:
 * 1. Finding recent bookings
 * 2. Checking if they have email/phone (required for tickets)
 * 3. Providing instructions on where to find server logs
 */

const API_URL = 'http://localhost:3001/api';
const TEST_TENANT_ID = 'd49e292b-b403-4268-a271-2ddc9704601b';

async function main() {
  console.log('\n' + '='.repeat(70));
  console.log('TICKET GENERATION STATUS CHECK');
  console.log('='.repeat(70) + '\n');
  
  console.log('‚ö†Ô∏è  WHERE TO FIND SERVER LOGS:');
  console.log('');
  console.log('Server logs appear in the TERMINAL where you started the server,');
  console.log('NOT in the browser console (F12).');
  console.log('');
  console.log('To find server logs:');
  console.log('  1. Find the terminal/command prompt where you ran: npm run dev');
  console.log('  2. That terminal shows all server console.log() output');
  console.log('  3. Look for ticket generation logs there');
  console.log('');
  console.log('='.repeat(70) + '\n');
  
  // Check server
  try {
    await fetch('http://localhost:3001/health');
    console.log('‚úì Server is running\n');
  } catch (error) {
    console.error('‚ùå Server not running\n');
    process.exit(1);
  }
  
  // Get recent bookings
  console.log('Checking recent bookings...\n');
  try {
    const res = await fetch(
      `${API_URL}/query?table=bookings&select=id,customer_name,customer_email,customer_phone,status,created_at&where=${encodeURIComponent(JSON.stringify({ tenant_id: TEST_TENANT_ID }))}&order=created_at&desc=true&limit=5`
    );
    const bookings = await res.json();
    const bookingArray = Array.isArray(bookings) ? bookings : (bookings.data || []);
    
    if (bookingArray.length === 0) {
      console.log('No bookings found.\n');
      console.log('To test ticket generation:');
      console.log('  1. Create a booking via UI: http://localhost:5173/fci/book');
      console.log('  2. Check your SERVER TERMINAL (not browser F12) for logs\n');
      return;
    }
    
    console.log(`Found ${bookingArray.length} recent booking(s):\n`);
    
    bookingArray.forEach((booking, index) => {
      console.log(`${index + 1}. Booking ID: ${booking.id}`);
      console.log(`   Customer: ${booking.customer_name || 'N/A'}`);
      console.log(`   Email: ${booking.customer_email || 'N/A'}`);
      console.log(`   Phone: ${booking.customer_phone || 'N/A'}`);
      console.log(`   Status: ${booking.status || 'N/A'}`);
      console.log(`   Created: ${booking.created_at || 'N/A'}`);
      
      // Check if ticket generation should have happened
      if (booking.customer_email || booking.customer_phone) {
        console.log(`   ‚úì Has contact info - ticket generation should have run`);
      } else {
        console.log(`   ‚ö†Ô∏è  No email or phone - ticket generation skipped`);
      }
      console.log('');
    });
    
    console.log('='.repeat(70));
    console.log('WHAT TO CHECK');
    console.log('='.repeat(70));
    console.log('');
    console.log('For each booking above, check your SERVER TERMINAL for:');
    console.log('');
    console.log('üìß ========================================');
    console.log('üìß Starting ticket generation for booking <ID>...');
    console.log('üìÑ Step 1: Generating PDF...');
    console.log('‚úÖ Step 1 Complete: PDF generated successfully');
    console.log('üì± Step 2: Attempting to send ticket via WhatsApp...');
    console.log('‚úÖ Step 2 Complete: Ticket PDF sent via WhatsApp');
    console.log('üìß Step 3: Attempting to send ticket via Email...');
    console.log('‚úÖ Step 3 Complete: Ticket PDF sent via Email');
    console.log('');
    console.log('='.repeat(70));
    console.log('');
    console.log('If you DON\'T see these logs in SERVER TERMINAL:');
    console.log('  1. Make sure you\'re looking at the correct terminal');
    console.log('  2. Check for errors in server terminal');
    console.log('  3. Verify server is running');
    console.log('  4. Check if booking has email/phone (required)');
    console.log('');
    console.log('='.repeat(70));
    console.log('VERIFICATION');
    console.log('='.repeat(70));
    console.log('');
    console.log('To verify tickets were actually sent:');
    console.log('  1. Check email inbox for "Booking Ticket" email');
    console.log('  2. Check WhatsApp for ticket PDF');
    console.log('  3. Check server terminal for delivery confirmation');
    console.log('');
    
  } catch (error) {
    console.error('Error:', error.message);
  }
}

main().catch(err => {
  console.error('\nFatal error:', err.message);
  process.exit(1);
});
